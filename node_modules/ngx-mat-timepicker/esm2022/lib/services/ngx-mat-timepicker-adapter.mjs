import { NgxMatTimepickerFormat } from "../models/ngx-mat-timepicker-format.enum";
import { NgxMatTimepickerPeriods } from "../models/ngx-mat-timepicker-periods.enum";
//
import { DateTime } from "ts-luxon";
// @dynamic
export class NgxMatTimepickerAdapter {
    static { this.defaultFormat = 12; }
    static { this.defaultLocale = "en-US"; }
    static { this.defaultNumberingSystem = "latn"; }
    /***
     *  Format hour according to time format (12 or 24)
     */
    static formatHour(currentHour, format, period) {
        if (this.isTwentyFour(format)) {
            return currentHour;
        }
        const hour = period === NgxMatTimepickerPeriods.AM ? currentHour : currentHour + 12;
        if (period === NgxMatTimepickerPeriods.AM && hour === 12) {
            return 0;
        }
        else if (period === NgxMatTimepickerPeriods.PM && hour === 24) {
            return 12;
        }
        return hour;
    }
    static formatTime(time, opts) {
        if (!time) {
            return "Invalid Time";
        }
        const parsedTime = this.parseTime(time, opts).setLocale(this.defaultLocale);
        if (!parsedTime.isValid) {
            return "Invalid time";
        }
        const isTwelve = !this.isTwentyFour(opts.format);
        if (isTwelve) {
            return parsedTime.toLocaleString({
                ...DateTime.TIME_SIMPLE,
                hour12: isTwelve
            }).replace(/\u200E/g, "");
        }
        return parsedTime.toISOTime({
            includeOffset: false,
            suppressMilliseconds: true,
            suppressSeconds: true
        }).replace(/\u200E/g, "");
    }
    static fromDateTimeToString(time, format) {
        return time.reconfigure({
            numberingSystem: this.defaultNumberingSystem,
            locale: this.defaultLocale
        }).toFormat(this.isTwentyFour(format) ? NgxMatTimepickerFormat.TWENTY_FOUR : NgxMatTimepickerFormat.TWELVE);
    }
    static isBetween(time, before, after, unit = "minutes") {
        const innerUnit = unit === "hours" ? unit : void 0;
        return this.isSameOrBefore(time, after, innerUnit) && this.isSameOrAfter(time, before, innerUnit);
    }
    static isSameOrAfter(time, compareWith, unit = "minutes") {
        if (unit === "hours") {
            return time.hour >= compareWith.hour;
        }
        return time.hasSame(compareWith, unit) || time.valueOf() > compareWith.valueOf();
    }
    static isSameOrBefore(time, compareWith, unit = "minutes") {
        if (unit === "hours") {
            return time.hour <= compareWith.hour;
        }
        return time.hasSame(compareWith, unit) || time.valueOf() <= compareWith.valueOf();
    }
    static isTimeAvailable(time, min, max, granularity, minutesGap, format) {
        if (!time) {
            return void 0;
        }
        const convertedTime = this.parseTime(time, { format });
        const minutes = convertedTime.minute;
        if (minutesGap && minutes === minutes && minutes % minutesGap !== 0) {
            throw new Error(`Your minutes - ${minutes} doesn\'t match your minutesGap - ${minutesGap}`);
        }
        const isAfter = (min && !max)
            && this.isSameOrAfter(convertedTime, min, granularity);
        const isBefore = (max && !min)
            && this.isSameOrBefore(convertedTime, max, granularity);
        const between = (min && max)
            && this.isBetween(convertedTime, min, max, granularity);
        const isAvailable = !min && !max;
        return isAfter || isBefore || between || isAvailable;
    }
    static isTwentyFour(format) {
        return format === 24;
    }
    static parseTime(time, opts) {
        const localeOpts = this._getLocaleOptionsByTime(time, opts);
        let timeMask = NgxMatTimepickerFormat.TWENTY_FOUR_SHORT;
        // If there's a space, means we have the meridiem. Way faster than splitting text
        // if (~time.indexOf(" ")) {
        // 09/02/2023 it seems that sometimes the space from the formatter is a nnbsp (Chromium >= 110)
        // which causes the indexOf(" ") to fail: charCode 32, while nbsp is 8239
        if (time.match(/\s/g)) {
            /*
             * We translate the meridiem in simple AM or PM letters (instead of A.M.)
             * because even if we set the locale with NgxMatTimepickerModule.setLocale
             * the default (en-US) will always be used here
             */
            time = time.replace(/\.\s*/g, "");
            timeMask = NgxMatTimepickerFormat.TWELVE_SHORT;
        }
        return DateTime.fromFormat(time.replace(/\s+/g, " "), timeMask, {
            numberingSystem: localeOpts.numberingSystem,
            locale: localeOpts.locale
        });
    }
    static toLocaleTimeString(time, opts = {}) {
        const { format = this.defaultFormat, locale = this.defaultLocale } = opts;
        let hourCycle = "h12";
        let timeMask = NgxMatTimepickerFormat.TWELVE_SHORT;
        if (this.isTwentyFour(format)) {
            hourCycle = "h23";
            timeMask = NgxMatTimepickerFormat.TWENTY_FOUR_SHORT;
        }
        return DateTime.fromFormat(time, timeMask).reconfigure({
            locale,
            numberingSystem: opts.numberingSystem,
            defaultToEN: opts.defaultToEN,
            outputCalendar: opts.outputCalendar
        }).toLocaleString({
            ...DateTime.TIME_SIMPLE,
            hourCycle
        });
    }
    /**
     *
     * @param time
     * @param opts
     * @private
     */
    static _getLocaleOptionsByTime(time, opts) {
        const { numberingSystem, locale } = DateTime.now().reconfigure({
            locale: opts.locale,
            numberingSystem: opts.numberingSystem,
            outputCalendar: opts.outputCalendar,
            defaultToEN: opts.defaultToEN
        }).resolvedLocaleOptions();
        return isNaN(parseInt(time, 10)) ? {
            numberingSystem: numberingSystem,
            locale
        } : {
            numberingSystem: this.defaultNumberingSystem,
            locale: this.defaultLocale
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW1hdC10aW1lcGlja2VyLWFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtbWF0LXRpbWVwaWNrZXIvc3JjL2xpYi9zZXJ2aWNlcy9uZ3gtbWF0LXRpbWVwaWNrZXItYWRhcHRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsc0JBQXNCLEVBQUMsTUFBTSwwQ0FBMEMsQ0FBQztBQUVoRixPQUFPLEVBQUMsdUJBQXVCLEVBQUMsTUFBTSwyQ0FBMkMsQ0FBQztBQUVsRixFQUFFO0FBQ0YsT0FBTyxFQUFDLFFBQVEsRUFBaUMsTUFBTSxVQUFVLENBQUM7QUFFbEUsV0FBVztBQUNYLE1BQU0sT0FBTyx1QkFBdUI7YUFFekIsa0JBQWEsR0FBK0IsRUFBRSxDQUFDO2FBQy9DLGtCQUFhLEdBQVcsT0FBTyxDQUFDO2FBQ2hDLDJCQUFzQixHQUFvQixNQUFNLENBQUM7SUFFeEQ7O09BRUc7SUFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLFdBQW1CLEVBQUUsTUFBa0MsRUFBRSxNQUErQjtRQUN0RyxJQUFJLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUM1QixPQUFPLFdBQVcsQ0FBQztRQUN2QixDQUFDO1FBQ0QsTUFBTSxJQUFJLEdBQUcsTUFBTSxLQUFLLHVCQUF1QixDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBRXBGLElBQUksTUFBTSxLQUFLLHVCQUF1QixDQUFDLEVBQUUsSUFBSSxJQUFJLEtBQUssRUFBRSxFQUFFLENBQUM7WUFDdkQsT0FBTyxDQUFDLENBQUM7UUFDYixDQUFDO2FBQ0ksSUFBSSxNQUFNLEtBQUssdUJBQXVCLENBQUMsRUFBRSxJQUFJLElBQUksS0FBSyxFQUFFLEVBQUUsQ0FBQztZQUM1RCxPQUFPLEVBQUUsQ0FBQztRQUNkLENBQUM7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Q2xCLFFBQVEsR0FBRyxzQkFBc0IsQ0FBQyxpQkFBaUIsQ0FBQztRQUN4RCxDQUFDO1FBRUQsT0FBTyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQyxXQUFXLENBQUM7WUFDbkQsTUFBTTtZQUNOLGVBQWUsRUFBRSxJQUFJLENBQUMsZUFBZTtZQUNyQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsY0FBYyxFQUFFLElBQUksQ0FBQyxjQUFjO1NBQ3RDLENBQUMsQ0FBQyxjQUFjLENBQUM7WUFDZCxHQUFHLFFBQVEsQ0FBQyxXQUFXO1lBQ3ZCLFNBQVM7U0FDWixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSyxNQUFNLENBQUMsdUJBQXVCLENBQUMsSUFBWSxFQUFFLElBQTZCO1FBQzlFLE1BQU0sRUFBQyxlQUFlLEVBQUUsTUFBTSxFQUFDLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLFdBQVcsQ0FBQztZQUN6RCxNQUFNLEVBQUUsSUFBSSxDQUFDLE1BQU07WUFDbkIsZUFBZSxFQUFFLElBQUksQ0FBQyxlQUFlO1lBQ3JDLGNBQWMsRUFBRSxJQUFJLENBQUMsY0FBYztZQUNuQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7U0FDaEMsQ0FBQyxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFFM0IsT0FBTyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQixlQUFlLEVBQUUsZUFBa0M7WUFDbkQsTUFBTTtTQUNULENBQUMsQ0FBQyxDQUFDO1lBQ0EsZUFBZSxFQUFFLElBQUksQ0FBQyxzQkFBc0I7WUFDNUMsTUFBTSxFQUFFLElBQUksQ0FBQyxhQUFhO1NBQzdCLENBQUM7SUFDTixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyRm9ybWF0fSBmcm9tIFwiLi4vbW9kZWxzL25neC1tYXQtdGltZXBpY2tlci1mb3JtYXQuZW51bVwiO1xyXG5pbXBvcnQge05neE1hdFRpbWVwaWNrZXJGb3JtYXRUeXBlfSBmcm9tIFwiLi4vbW9kZWxzL25neC1tYXQtdGltZXBpY2tlci1mb3JtYXQudHlwZVwiO1xyXG5pbXBvcnQge05neE1hdFRpbWVwaWNrZXJQZXJpb2RzfSBmcm9tIFwiLi4vbW9kZWxzL25neC1tYXQtdGltZXBpY2tlci1wZXJpb2RzLmVudW1cIjtcclxuaW1wb3J0IHtOZ3hNYXRUaW1lcGlja2VyT3B0aW9uc30gZnJvbSBcIi4uL21vZGVscy9uZ3gtbWF0LXRpbWVwaWNrZXItb3B0aW9ucy5pbnRlcmZhY2VcIjtcclxuLy9cclxuaW1wb3J0IHtEYXRlVGltZSwgTG9jYWxlT3B0aW9ucywgTnVtYmVyaW5nU3lzdGVtfSBmcm9tIFwidHMtbHV4b25cIjtcclxuXHJcbi8vIEBkeW5hbWljXHJcbmV4cG9ydCBjbGFzcyBOZ3hNYXRUaW1lcGlja2VyQWRhcHRlciB7XHJcblxyXG4gICAgc3RhdGljIGRlZmF1bHRGb3JtYXQ6IE5neE1hdFRpbWVwaWNrZXJGb3JtYXRUeXBlID0gMTI7XHJcbiAgICBzdGF0aWMgZGVmYXVsdExvY2FsZTogc3RyaW5nID0gXCJlbi1VU1wiO1xyXG4gICAgc3RhdGljIGRlZmF1bHROdW1iZXJpbmdTeXN0ZW06IE51bWJlcmluZ1N5c3RlbSA9IFwibGF0blwiO1xyXG5cclxuICAgIC8qKipcclxuICAgICAqICBGb3JtYXQgaG91ciBhY2NvcmRpbmcgdG8gdGltZSBmb3JtYXQgKDEyIG9yIDI0KVxyXG4gICAgICovXHJcbiAgICBzdGF0aWMgZm9ybWF0SG91cihjdXJyZW50SG91cjogbnVtYmVyLCBmb3JtYXQ6IE5neE1hdFRpbWVwaWNrZXJGb3JtYXRUeXBlLCBwZXJpb2Q6IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzKTogbnVtYmVyIHtcclxuICAgICAgICBpZiAodGhpcy5pc1R3ZW50eUZvdXIoZm9ybWF0KSkge1xyXG4gICAgICAgICAgICByZXR1cm4gY3VycmVudEhvdXI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IGhvdXIgPSBwZXJpb2QgPT09IE5neE1hdFRpbWVwaWNrZXJQZXJpb2RzLkFNID8gY3VycmVudEhvdXIgOiBjdXJyZW50SG91ciArIDEyO1xyXG5cclxuICAgICAgICBpZiAocGVyaW9kID09PSBOZ3hNYXRUaW1lcGlja2VyUGVyaW9kcy5BTSAmJiBob3VyID09PSAxMikge1xyXG4gICAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZWxzZSBpZiAocGVyaW9kID09PSBOZ3hNYXRUaW1lcGlja2VyUGVyaW9kcy5QTSAmJiBob3VyID09PSAyNCkge1xyXG4gICAgICAgICAgICByZXR1cm4gMTI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gaG91cjtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgZm9ybWF0VGltZSh0aW1lOiBzdHJpbmcsIG9wdHM6IE5neE1hdFRpbWVwaWNrZXJPcHRpb25zKTogc3RyaW5nIHtcclxuICAgICAgICBpZiAoIXRpbWUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIFwiSW52YWxpZCBUaW1lXCI7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHBhcnNlZFRpbWUgPSB0aGlzLnBhcnNlVGltZSh0aW1lLCBvcHRzKS5zZXRMb2NhbGUodGhpcy5kZWZhdWx0TG9jYWxlKTtcclxuICAgICAgICBpZiAoIXBhcnNlZFRpbWUuaXNWYWxpZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gXCJJbnZhbGlkIHRpbWVcIjtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaXNUd2VsdmUgPSAhdGhpcy5pc1R3ZW50eUZvdXIob3B0cy5mb3JtYXQgYXMgTmd4TWF0VGltZXBpY2tlckZvcm1hdFR5cGUpO1xyXG4gICAgICAgIGlmIChpc1R3ZWx2ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gcGFyc2VkVGltZS50b0xvY2FsZVN0cmluZyh7XHJcbiAgICAgICAgICAgICAgICAuLi5EYXRlVGltZS5USU1FX1NJTVBMRSxcclxuICAgICAgICAgICAgICAgIGhvdXIxMjogaXNUd2VsdmVcclxuICAgICAgICAgICAgfSkucmVwbGFjZSgvXFx1MjAwRS9nLCBcIlwiKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBwYXJzZWRUaW1lLnRvSVNPVGltZSh7XHJcbiAgICAgICAgICAgIGluY2x1ZGVPZmZzZXQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBzdXBwcmVzc01pbGxpc2Vjb25kczogdHJ1ZSxcclxuICAgICAgICAgICAgc3VwcHJlc3NTZWNvbmRzOiB0cnVlXHJcbiAgICAgICAgfSkucmVwbGFjZSgvXFx1MjAwRS9nLCBcIlwiKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgZnJvbURhdGVUaW1lVG9TdHJpbmcodGltZTogRGF0ZVRpbWUsIGZvcm1hdDogTmd4TWF0VGltZXBpY2tlckZvcm1hdFR5cGUpOiBzdHJpbmcge1xyXG5cclxuICAgICAgICByZXR1cm4gdGltZS5yZWNvbmZpZ3VyZSh7XHJcbiAgICAgICAgICAgIG51bWJlcmluZ1N5c3RlbTogdGhpcy5kZWZhdWx0TnVtYmVyaW5nU3lzdGVtLFxyXG4gICAgICAgICAgICBsb2NhbGU6IHRoaXMuZGVmYXVsdExvY2FsZVxyXG4gICAgICAgIH0pLnRvRm9ybWF0KHRoaXMuaXNUd2VudHlGb3VyKGZvcm1hdCkgPyBOZ3hNYXRUaW1lcGlja2VyRm9ybWF0LlRXRU5UWV9GT1VSIDogTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VMVkUpO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBpc0JldHdlZW4odGltZTogRGF0ZVRpbWUsIGJlZm9yZTogRGF0ZVRpbWUsIGFmdGVyOiBEYXRlVGltZSwgdW5pdDogXCJob3Vyc1wiIHwgXCJtaW51dGVzXCIgPSBcIm1pbnV0ZXNcIik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGNvbnN0IGlubmVyVW5pdCA9IHVuaXQgPT09IFwiaG91cnNcIiA/IHVuaXQgOiB2b2lkIDA7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmlzU2FtZU9yQmVmb3JlKHRpbWUsIGFmdGVyLCBpbm5lclVuaXQpICYmIHRoaXMuaXNTYW1lT3JBZnRlcih0aW1lLCBiZWZvcmUsIGlubmVyVW5pdCk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGlzU2FtZU9yQWZ0ZXIodGltZTogRGF0ZVRpbWUsIGNvbXBhcmVXaXRoOiBEYXRlVGltZSwgdW5pdDogXCJob3Vyc1wiIHwgXCJtaW51dGVzXCIgPSBcIm1pbnV0ZXNcIik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh1bml0ID09PSBcImhvdXJzXCIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRpbWUuaG91ciA+PSBjb21wYXJlV2l0aC5ob3VyO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRpbWUuaGFzU2FtZShjb21wYXJlV2l0aCwgdW5pdCkgfHwgdGltZS52YWx1ZU9mKCkgPiBjb21wYXJlV2l0aC52YWx1ZU9mKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc3RhdGljIGlzU2FtZU9yQmVmb3JlKHRpbWU6IERhdGVUaW1lLCBjb21wYXJlV2l0aDogRGF0ZVRpbWUsIHVuaXQ6IFwiaG91cnNcIiB8IFwibWludXRlc1wiID0gXCJtaW51dGVzXCIpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAodW5pdCA9PT0gXCJob3Vyc1wiKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aW1lLmhvdXIgPD0gY29tcGFyZVdpdGguaG91cjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aW1lLmhhc1NhbWUoY29tcGFyZVdpdGgsIHVuaXQpIHx8IHRpbWUudmFsdWVPZigpIDw9IGNvbXBhcmVXaXRoLnZhbHVlT2YoKTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgaXNUaW1lQXZhaWxhYmxlKHRpbWU6IHN0cmluZyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgbWluPzogRGF0ZVRpbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIG1heD86IERhdGVUaW1lLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBncmFudWxhcml0eT86IFwiaG91cnNcIiB8IFwibWludXRlc1wiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICBtaW51dGVzR2FwPzogbnVtYmVyIHwgbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0PzogbnVtYmVyKTogYm9vbGVhbiB7XHJcbiAgICAgICAgaWYgKCF0aW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB2b2lkIDA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBjb252ZXJ0ZWRUaW1lID0gdGhpcy5wYXJzZVRpbWUodGltZSwge2Zvcm1hdH0pO1xyXG4gICAgICAgIGNvbnN0IG1pbnV0ZXMgPSBjb252ZXJ0ZWRUaW1lLm1pbnV0ZTtcclxuXHJcbiAgICAgICAgaWYgKG1pbnV0ZXNHYXAgJiYgbWludXRlcyA9PT0gbWludXRlcyAmJiBtaW51dGVzICUgbWludXRlc0dhcCAhPT0gMCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFlvdXIgbWludXRlcyAtICR7bWludXRlc30gZG9lc25cXCd0IG1hdGNoIHlvdXIgbWludXRlc0dhcCAtICR7bWludXRlc0dhcH1gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc3QgaXNBZnRlciA9IChtaW4gJiYgIW1heClcclxuICAgICAgICAgICAgJiYgdGhpcy5pc1NhbWVPckFmdGVyKGNvbnZlcnRlZFRpbWUsIG1pbiwgZ3JhbnVsYXJpdHkpO1xyXG4gICAgICAgIGNvbnN0IGlzQmVmb3JlID0gKG1heCAmJiAhbWluKVxyXG4gICAgICAgICAgICAmJiB0aGlzLmlzU2FtZU9yQmVmb3JlKGNvbnZlcnRlZFRpbWUsIG1heCwgZ3JhbnVsYXJpdHkpO1xyXG4gICAgICAgIGNvbnN0IGJldHdlZW4gPSAobWluICYmIG1heClcclxuICAgICAgICAgICAgJiYgdGhpcy5pc0JldHdlZW4oY29udmVydGVkVGltZSwgbWluLCBtYXgsIGdyYW51bGFyaXR5KTtcclxuICAgICAgICBjb25zdCBpc0F2YWlsYWJsZSA9ICFtaW4gJiYgIW1heDtcclxuXHJcbiAgICAgICAgcmV0dXJuIGlzQWZ0ZXIgfHwgaXNCZWZvcmUgfHwgYmV0d2VlbiB8fCBpc0F2YWlsYWJsZTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgaXNUd2VudHlGb3VyKGZvcm1hdDogTmd4TWF0VGltZXBpY2tlckZvcm1hdFR5cGUpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gZm9ybWF0ID09PSAyNDtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgcGFyc2VUaW1lKHRpbWU6IHN0cmluZywgb3B0czogTmd4TWF0VGltZXBpY2tlck9wdGlvbnMpOiBEYXRlVGltZSB7XHJcbiAgICAgICAgY29uc3QgbG9jYWxlT3B0cyA9IHRoaXMuX2dldExvY2FsZU9wdGlvbnNCeVRpbWUodGltZSwgb3B0cyk7XHJcbiAgICAgICAgbGV0IHRpbWVNYXNrID0gTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VOVFlfRk9VUl9TSE9SVDtcclxuICAgICAgICAvLyBJZiB0aGVyZSdzIGEgc3BhY2UsIG1lYW5zIHdlIGhhdmUgdGhlIG1lcmlkaWVtLiBXYXkgZmFzdGVyIHRoYW4gc3BsaXR0aW5nIHRleHRcclxuICAgICAgICAvLyBpZiAofnRpbWUuaW5kZXhPZihcIiBcIikpIHtcclxuICAgICAgICAvLyAwOS8wMi8yMDIzIGl0IHNlZW1zIHRoYXQgc29tZXRpbWVzIHRoZSBzcGFjZSBmcm9tIHRoZSBmb3JtYXR0ZXIgaXMgYSBubmJzcCAoQ2hyb21pdW0gPj0gMTEwKVxyXG4gICAgICAgIC8vIHdoaWNoIGNhdXNlcyB0aGUgaW5kZXhPZihcIiBcIikgdG8gZmFpbDogY2hhckNvZGUgMzIsIHdoaWxlIG5ic3AgaXMgODIzOVxyXG4gICAgICAgIGlmICh0aW1lLm1hdGNoKC9cXHMvZykpIHtcclxuICAgICAgICAgICAgLypcclxuICAgICAgICAgICAgICogV2UgdHJhbnNsYXRlIHRoZSBtZXJpZGllbSBpbiBzaW1wbGUgQU0gb3IgUE0gbGV0dGVycyAoaW5zdGVhZCBvZiBBLk0uKVxyXG4gICAgICAgICAgICAgKiBiZWNhdXNlIGV2ZW4gaWYgd2Ugc2V0IHRoZSBsb2NhbGUgd2l0aCBOZ3hNYXRUaW1lcGlja2VyTW9kdWxlLnNldExvY2FsZVxyXG4gICAgICAgICAgICAgKiB0aGUgZGVmYXVsdCAoZW4tVVMpIHdpbGwgYWx3YXlzIGJlIHVzZWQgaGVyZVxyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgdGltZSA9IHRpbWUucmVwbGFjZSgvXFwuXFxzKi9nLCBcIlwiKTtcclxuICAgICAgICAgICAgdGltZU1hc2sgPSBOZ3hNYXRUaW1lcGlja2VyRm9ybWF0LlRXRUxWRV9TSE9SVDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBEYXRlVGltZS5mcm9tRm9ybWF0KHRpbWUucmVwbGFjZSgvXFxzKy9nLCBcIiBcIiksIHRpbWVNYXNrLCB7XHJcbiAgICAgICAgICAgIG51bWJlcmluZ1N5c3RlbTogbG9jYWxlT3B0cy5udW1iZXJpbmdTeXN0ZW0sXHJcbiAgICAgICAgICAgIGxvY2FsZTogbG9jYWxlT3B0cy5sb2NhbGVcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgdG9Mb2NhbGVUaW1lU3RyaW5nKHRpbWU6IHN0cmluZywgb3B0czogTmd4TWF0VGltZXBpY2tlck9wdGlvbnMgPSB7fSk6IHN0cmluZyB7XHJcbiAgICAgICAgY29uc3Qge2Zvcm1hdCA9IHRoaXMuZGVmYXVsdEZvcm1hdCwgbG9jYWxlID0gdGhpcy5kZWZhdWx0TG9jYWxlfSA9IG9wdHM7XHJcbiAgICAgICAgbGV0IGhvdXJDeWNsZTogXCJoMTJcIiB8IFwiaDIzXCIgPSBcImgxMlwiO1xyXG4gICAgICAgIGxldCB0aW1lTWFzayA9IE5neE1hdFRpbWVwaWNrZXJGb3JtYXQuVFdFTFZFX1NIT1JUO1xyXG4gICAgICAgIGlmICh0aGlzLmlzVHdlbnR5Rm91cihmb3JtYXQgYXMgTmd4TWF0VGltZXBpY2tlckZvcm1hdFR5cGUpKSB7XHJcbiAgICAgICAgICAgIGhvdXJDeWNsZSA9IFwiaDIzXCI7XHJcbiAgICAgICAgICAgIHRpbWVNYXNrID0gTmd4TWF0VGltZXBpY2tlckZvcm1hdC5UV0VOVFlfRk9VUl9TSE9SVDtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBEYXRlVGltZS5mcm9tRm9ybWF0KHRpbWUsIHRpbWVNYXNrKS5yZWNvbmZpZ3VyZSh7XHJcbiAgICAgICAgICAgIGxvY2FsZSxcclxuICAgICAgICAgICAgbnVtYmVyaW5nU3lzdGVtOiBvcHRzLm51bWJlcmluZ1N5c3RlbSxcclxuICAgICAgICAgICAgZGVmYXVsdFRvRU46IG9wdHMuZGVmYXVsdFRvRU4sXHJcbiAgICAgICAgICAgIG91dHB1dENhbGVuZGFyOiBvcHRzLm91dHB1dENhbGVuZGFyXHJcbiAgICAgICAgfSkudG9Mb2NhbGVTdHJpbmcoe1xyXG4gICAgICAgICAgICAuLi5EYXRlVGltZS5USU1FX1NJTVBMRSxcclxuICAgICAgICAgICAgaG91ckN5Y2xlXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKlxyXG4gICAgICogQHBhcmFtIHRpbWVcclxuICAgICAqIEBwYXJhbSBvcHRzXHJcbiAgICAgKiBAcHJpdmF0ZVxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIHN0YXRpYyBfZ2V0TG9jYWxlT3B0aW9uc0J5VGltZSh0aW1lOiBzdHJpbmcsIG9wdHM6IE5neE1hdFRpbWVwaWNrZXJPcHRpb25zKTogTG9jYWxlT3B0aW9ucyB7XHJcbiAgICAgICAgY29uc3Qge251bWJlcmluZ1N5c3RlbSwgbG9jYWxlfSA9IERhdGVUaW1lLm5vdygpLnJlY29uZmlndXJlKHtcclxuICAgICAgICAgICAgbG9jYWxlOiBvcHRzLmxvY2FsZSxcclxuICAgICAgICAgICAgbnVtYmVyaW5nU3lzdGVtOiBvcHRzLm51bWJlcmluZ1N5c3RlbSxcclxuICAgICAgICAgICAgb3V0cHV0Q2FsZW5kYXI6IG9wdHMub3V0cHV0Q2FsZW5kYXIsXHJcbiAgICAgICAgICAgIGRlZmF1bHRUb0VOOiBvcHRzLmRlZmF1bHRUb0VOXHJcbiAgICAgICAgfSkucmVzb2x2ZWRMb2NhbGVPcHRpb25zKCk7XHJcblxyXG4gICAgICAgIHJldHVybiBpc05hTihwYXJzZUludCh0aW1lLCAxMCkpID8ge1xyXG4gICAgICAgICAgICBudW1iZXJpbmdTeXN0ZW06IG51bWJlcmluZ1N5c3RlbSBhcyBOdW1iZXJpbmdTeXN0ZW0sXHJcbiAgICAgICAgICAgIGxvY2FsZVxyXG4gICAgICAgIH0gOiB7XHJcbiAgICAgICAgICAgIG51bWJlcmluZ1N5c3RlbTogdGhpcy5kZWZhdWx0TnVtYmVyaW5nU3lzdGVtLFxyXG4gICAgICAgICAgICBsb2NhbGU6IHRoaXMuZGVmYXVsdExvY2FsZVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcbn1cclxuIl19